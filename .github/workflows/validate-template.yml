name: Validate Plugin

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Plugin Structure

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check Required Files
        run: |
          echo "üîç Checking required files..."

          required_files=(
            "CLAUDE.md"
            "README.md"
            "LICENSE"
            ".claude/settings.json"
            ".claude/settings.local.json.example"
          )

          missing=0
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file"
            else
              echo "‚ùå Missing: $file"
              missing=$((missing + 1))
            fi
          done

          if [ $missing -gt 0 ]; then
            echo "::error::Missing $missing required file(s)"
            exit 1
          fi

          echo "‚úÖ All required files present"

      - name: Check Directory Structure
        run: |
          echo "üîç Checking directory structure..."

          required_dirs=(
            "commands"
            "rules"
            "skills"
            "agents"
            "scripts"
            "memory-bank"
          )

          missing=0
          for dir in "${required_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "‚úÖ $dir/"
            else
              echo "‚ùå Missing: $dir/"
              missing=$((missing + 1))
            fi
          done

          if [ $missing -gt 0 ]; then
            echo "::error::Missing $missing required directory(s)"
            exit 1
          fi

          echo "‚úÖ All required directories present"

      - name: Check Commands
        run: |
          echo "üîç Checking command files..."

          # Core commands that must exist
          core_commands=(
            "pm.md"
            "lead.md"
            "dev.md"
            "qa.md"
            "iterate.md"
            "commit.md"
          )

          cd commands
          missing=0
          for cmd in "${core_commands[@]}"; do
            if [ -f "$cmd" ]; then
              echo "‚úÖ $cmd"
            else
              echo "‚ùå Missing: $cmd"
              missing=$((missing + 1))
            fi
          done

          if [ $missing -gt 0 ]; then
            echo "::error::Missing $missing core command(s)"
            exit 1
          fi

          # Count total commands
          total=$(ls -1 *.md 2>/dev/null | wc -l)
          echo "üìä Total commands: $total"

      - name: Check Rules
        run: |
          echo "üîç Checking rule files..."

          core_rules=(
            "methodology.md"
            "coding-standards.md"
            "security.md"
          )

          cd rules
          missing=0
          for rule in "${core_rules[@]}"; do
            if [ -f "$rule" ]; then
              echo "‚úÖ $rule"
            else
              echo "‚ùå Missing: $rule"
              missing=$((missing + 1))
            fi
          done

          if [ $missing -gt 0 ]; then
            echo "::error::Missing $missing core rule(s)"
            exit 1
          fi

          total=$(ls -1 *.md 2>/dev/null | wc -l)
          echo "üìä Total rules: $total"

      - name: Check Scripts Syntax
        run: |
          echo "üîç Checking Python scripts syntax..."

          for script in scripts/python/*.py; do
            if [ -f "$script" ]; then
              python -m py_compile "$script" && echo "‚úÖ $script" || {
                echo "‚ùå Syntax error: $script"
                exit 1
              }
            fi
          done

          echo "‚úÖ All Python scripts have valid syntax"

      - name: Check JSON Files
        run: |
          echo "üîç Checking JSON files..."

          # Core JSON files
          json_files=(
            ".claude/settings.json"
            ".claude-plugin/plugin.json"
            ".claude-plugin/marketplace.json"
            "hooks/hooks.json"
          )

          errors=0
          for file in "${json_files[@]}"; do
            if [ -f "$file" ]; then
              if python -c "import json; json.load(open('$file'))" 2>/dev/null; then
                echo "‚úÖ $file"
              else
                echo "‚ùå Invalid JSON: $file"
                errors=$((errors + 1))
              fi
            else
              echo "‚ö†Ô∏è Optional file not found: $file"
            fi
          done

          # Check all JSON files in skills/
          for file in $(find skills -name "*.json" 2>/dev/null); do
            if python -c "import json; json.load(open('$file'))" 2>/dev/null; then
              echo "‚úÖ $file"
            else
              echo "‚ùå Invalid JSON: $file"
              errors=$((errors + 1))
            fi
          done

          if [ $errors -gt 0 ]; then
            echo "::error::Found $errors invalid JSON file(s)"
            exit 1
          fi

          echo "‚úÖ All JSON files are valid"

      - name: Validate Plugin Manifest
        run: |
          echo "üîç Validating plugin.json..."

          python << 'EOF'
          import json
          import sys

          required_fields = ["name", "version", "description"]

          with open(".claude-plugin/plugin.json") as f:
              plugin = json.load(f)

          missing = [f for f in required_fields if f not in plugin]
          if missing:
              print(f"‚ùå Missing required fields: {missing}")
              sys.exit(1)

          # Version format check (semver)
          version = plugin.get("version", "")
          parts = version.split(".")
          if len(parts) != 3 or not all(p.isdigit() for p in parts):
              print(f"‚ö†Ô∏è Version '{version}' may not follow semver")

          print(f"‚úÖ Plugin: {plugin['name']} v{plugin['version']}")
          EOF

      - name: Check Node.js Scripts Syntax
        run: |
          echo "üîç Checking Node.js scripts syntax..."

          errors=0
          for script in $(find scripts/node -name "*.js" 2>/dev/null); do
            if node --check "$script" 2>/dev/null; then
              echo "‚úÖ $script"
            else
              echo "‚ùå Syntax error: $script"
              errors=$((errors + 1))
            fi
          done

          if [ $errors -gt 0 ]; then
            echo "::error::Found $errors JavaScript file(s) with syntax errors"
            exit 1
          fi

          echo "‚úÖ All Node.js scripts have valid syntax"

      - name: Check Markdown Frontmatter
        run: |
          echo "üîç Checking Markdown frontmatter..."

          errors=0

          # Check commands have frontmatter
          for file in commands/*.md; do
            if [ -f "$file" ]; then
              if head -1 "$file" | grep -q "^---$"; then
                echo "‚úÖ $file"
              else
                echo "‚ùå Missing frontmatter: $file"
                errors=$((errors + 1))
              fi
            fi
          done

          # Check skills have proper frontmatter
          for file in $(find skills -name "SKILL.md" 2>/dev/null); do
            if head -1 "$file" | grep -q "^---$"; then
              # Check for required fields
              if grep -q "^name:" "$file" && grep -q "^description:" "$file"; then
                echo "‚úÖ $file"
              else
                echo "‚ö†Ô∏è Missing name/description in frontmatter: $file"
              fi
            else
              echo "‚ùå Missing frontmatter: $file"
              errors=$((errors + 1))
            fi
          done

          if [ $errors -gt 0 ]; then
            echo "::error::Found $errors file(s) with missing frontmatter"
            exit 1
          fi

          echo "‚úÖ All Markdown files have valid frontmatter"

      - name: Check Markdown Links (README)
        run: |
          echo "üîç Checking README.md links..."

          # Check for broken internal links
          grep -oP '\[.*?\]\(\K[^)]+' README.md | while read -r link; do
            # Skip external links and anchors
            if [[ "$link" == http* ]] || [[ "$link" == "#"* ]] || [[ "$link" == "../../"* ]]; then
              continue
            fi
            if [ -f "$link" ] || [ -d "$link" ]; then
              echo "‚úÖ $link"
            else
              echo "‚ö†Ô∏è Possible broken link: $link"
            fi
          done

          echo "‚úÖ README links checked"

      - name: Check Version Sync
        run: |
          echo "üîç Checking version synchronization..."

          # Get plugin version
          PLUGIN_VERSION=$(python -c "import json; print(json.load(open('.claude-plugin/plugin.json'))['version'])")
          echo "üì¶ Plugin version: $PLUGIN_VERSION"

          # Check COMMANDS.md version matches
          if grep -q "Version: $PLUGIN_VERSION" .claude-plugin/COMMANDS.md; then
            echo "‚úÖ COMMANDS.md version matches"
          else
            COMMANDS_VERSION=$(grep -oP 'Version: \K[0-9]+\.[0-9]+\.[0-9]+' .claude-plugin/COMMANDS.md || echo "not found")
            echo "‚ö†Ô∏è COMMANDS.md version ($COMMANDS_VERSION) differs from plugin.json ($PLUGIN_VERSION)"
          fi

          # Check component counts
          ACTUAL_COMMANDS=$(ls -1 commands/*.md 2>/dev/null | wc -l | tr -d ' ')
          ACTUAL_SKILLS=$(find skills -name "SKILL.md" 2>/dev/null | wc -l | tr -d ' ')
          ACTUAL_AGENTS=$(ls -1 agents/*.md 2>/dev/null | grep -v README | wc -l | tr -d ' ')
          ACTUAL_RULES=$(ls -1 rules/*.md 2>/dev/null | wc -l | tr -d ' ')

          echo "üìä Component counts:"
          echo "   Commands: $ACTUAL_COMMANDS"
          echo "   Skills: $ACTUAL_SKILLS"
          echo "   Agents: $ACTUAL_AGENTS"
          echo "   Rules: $ACTUAL_RULES"

          # Verify plugin.json description matches
          EXPECTED_DESC="35 commands, 17 skills, 8 agents"
          if grep -q "$EXPECTED_DESC" .claude-plugin/plugin.json; then
            echo "‚úÖ plugin.json description matches component counts"
          else
            echo "‚ö†Ô∏è plugin.json description may be outdated (expected: $ACTUAL_COMMANDS commands, $ACTUAL_SKILLS skills, $ACTUAL_AGENTS agents)"
          fi

          echo "‚úÖ Version sync check completed"

      - name: Summary
        run: |
          echo "## üìä Plugin Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get plugin info
          plugin_name=$(python -c "import json; print(json.load(open('.claude-plugin/plugin.json'))['name'])")
          plugin_version=$(python -c "import json; print(json.load(open('.claude-plugin/plugin.json'))['version'])")

          echo "**Plugin**: \`$plugin_name\` v$plugin_version" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commands | $(ls -1 commands/*.md 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| Rules | $(ls -1 rules/*.md 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| Skills | $(find skills -name "SKILL.md" 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| Agents | $(ls -1 agents/*.md 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js Scripts | $(find scripts/node -name "*.js" 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| JSON Configs | $(find . -name "*.json" -not -path "./node_modules/*" 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Validations Passed" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Required files and directories" >> $GITHUB_STEP_SUMMARY
          echo "- [x] JSON syntax validation" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Plugin manifest validation" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Node.js script syntax" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Markdown frontmatter" >> $GITHUB_STEP_SUMMARY
