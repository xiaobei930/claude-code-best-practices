---
paths:
  - "**/*"
description: 模型选择和上下文管理的性能优化策略
alwaysApply: true
---

# 性能优化策略

本文档定义模型选择和上下文管理的最佳实践。

## 模型选择策略

### Haiku（轻量快速）

适用场景：

- 简单查询和快速任务
- 轻量级 agent 的频繁调用
- 多 agent 系统中的 worker agent
- 结对编程中的快速响应

### Sonnet（均衡选择）

适用场景：

- 日常开发工作
- 代码生成和修改
- 协调多 agent 工作流
- 复杂编码任务

### Opus（深度推理）

适用场景：

- 复杂架构决策
- 需要最大推理能力的任务
- 研究和分析任务
- 代码审查（架构层面）

## 模型选择指南

| 场景     | 推荐模型 | 原因     |
| -------- | -------- | -------- |
| 架构设计 | Opus     | 深度推理 |
| 代码实现 | Sonnet   | 均衡质量 |
| 代码审查 | Opus     | 架构判断 |
| 简单查询 | Haiku    | 成本优化 |
| 快速任务 | Haiku    | 速度优先 |
| TDD 循环 | Sonnet   | 高频迭代 |
| 安全审查 | Opus     | 不漏关键 |

## 上下文窗口管理

### 避免在上下文末尾 20% 执行的任务

- 大规模重构
- 跨多文件的功能实现
- 复杂交互的调试

### 低上下文敏感任务

- 单文件编辑
- 独立工具函数创建
- 文档更新
- 简单 bug 修复

## 深度思考模式

对于复杂任务：

1. 使用 `ultrathink` 触发增强思考
2. 启用 Plan Mode 结构化规划
3. 多次批评迭代优化方案
4. 使用多角色子 agent 分析

## MCP 管理

- **配置数量**: 全局可配置 20-30 个
- **启用数量**: 每项目不超过 10 个
- **工具数量**: 活跃工具不超过 80 个
- **禁用方式**: 使用 `disabledMcpServers` 按项目禁用

## 并行执行优化

### 何时使用并行 Agent

- 多个独立的分析任务
- 多角度评估（安全/性能/可扩展性）
- 批量文件处理

### 并行执行示例

```
同时启动 3 个 agent：
1. Agent #1: 安全分析
2. Agent #2: 性能审查
3. Agent #3: 代码风格检查
```

**关键**: 在单个消息中发起多个 Task 调用，实现真正并行。

## 构建错误处理

构建失败时的流程：

1. 使用 build-error-resolver agent
2. 分析错误信息
3. 增量修复
4. 每次修复后验证
