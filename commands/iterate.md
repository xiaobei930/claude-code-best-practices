---
description: 自主迭代循环，自动完成任务序列
allowed-tools: Read, Write, Edit, Glob, Grep, Bash, TodoWrite, Task, WebSearch, WebFetch, Skill, mcp__*
---

# /iterate - 自主迭代循环

> **核心规则**: 任务完成后 **立即** 开始下一个任务，**禁止** 输出总结后等待用户。

单 session 内的自主开发循环。适合日常开发，在上下文窗口允许的范围内连续完成多个任务。

> 💡 需要长时间运行（小时级）？请直接使用 `/ralph-loop` 命令，参考 `.claude/ralph-prompts/` 下的模板。

---

## 核心流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    自主迭代循环                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  读取 progress.md → 选取任务 → 执行 → 验证 → 提交 → 更新文档     │
│         ↑                                              │        │
│         └──────────────────────────────────────────────┘        │
│                       自动继续下一任务                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**立即开始执行：**

1. 读取 `memory-bank/progress.md`
2. 确定当前任务
3. 按下方流程执行

---

## 执行流程

### Step 1: 确定角色

| 当前状态                            | 选择角色    | 动作                                 |
| ----------------------------------- | ----------- | ------------------------------------ |
| 无需求文档                          | `/pm`       | 需求分析                             |
| REQ 有待澄清项（≥1 个低置信度决策） | `/clarify`  | 需求澄清                             |
| 有需求无设计                        | `/lead`     | 技术设计                             |
| 有设计，前端任务未设计              | `/designer` | UI 设计指导                          |
| 有任务待开发                        | `/dev`      | 编码实现                             |
| 有代码待验证                        | `/verify`   | 综合验证（构建+类型+Lint+测试+安全） |
| 验证通过，待功能验收                | `/qa`       | 功能验收                             |
| QA 发现实现 Bug                     | `/dev`      | 修复后重新 `/verify`                 |

### Step 2: 执行任务

```
角色命令执行
  ├─ /dev: 编码实现 + 单元测试
  ├─ /verify: 构建 + 类型 + Lint + 测试 + 安全扫描
  ├─ /qa: 功能验收 + E2E 测试
  └─ 前端：浏览器验证（Playwright 截图）
```

### Step 3: 完成任务

```
/commit → 更新 progress.md → 读取下一任务 → 立即执行
```

**不要停下来！继续下一个任务。**

---

## 禁止行为

```
❌ 禁止：
   "任务已完成，需要我继续吗？"
   "当前状态如下...（等待用户响应）"
   "接下来您想做什么？"

✅ 正确：
   任务完成 → 更新文档 → 读取下一任务 → 立即执行
```

---

## 停止条件

**只有以下情况才能停止**：

1. ✅ 所有任务完成
2. ✅ 用户主动中断（Ctrl+C / Escape）
3. ✅ 遇到无法自动解决的致命错误
4. ✅ 需要用户决策的外部依赖
5. ✅ 上下文接近上限（提示用户后等待决定）

---

## 上下文管理

**不主动 /clear**，除非：

- 上下文使用率 > 80%（系统会提示）
- 遇到严重阻塞需要重新开始

**上下文过长时**：

```
检测到上下文接近上限（>80%）
├─ 保存当前状态到 progress.md
├─ 提示用户：建议执行 /clear 后重新启动 /iterate
└─ 等待用户决定（唯一允许等待的场景）
```

---

## 文档更新

每个任务完成后必须更新 `memory-bank/progress.md`：

```markdown
## 当前状态

- **Phase**: Phase 2 - US-1 实现
- **当前任务**: TSK-004 (已完成)
- **下一任务**: TSK-005

## 已完成

- [x] TSK-004: API 接口 - 2025-01-22

## 进行中

- [ ] TSK-005: 前端页面
```

---

## 与 /pair 的区别

| 对比项   | `/iterate`         | `/pair`              |
| -------- | ------------------ | -------------------- |
| 自主程度 | 完全自主           | 人机协作             |
| 用户参与 | 仅在阻塞时         | 每步确认             |
| 适用场景 | 明确任务的批量执行 | 学习、讨论、敏感操作 |
