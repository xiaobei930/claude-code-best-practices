---
description: 上下文压缩，减少 token 消耗
allowed-tools: Read, Write, Edit, Glob, Grep, TodoWrite
---

# /compact - 上下文压缩

智能压缩当前对话上下文，保留关键信息，释放 token 空间。

## 使用场景

- 对话过长，响应变慢
- 完成一个大功能后，准备开始新功能
- 上下文中有大量已完成任务的冗余讨论

## 执行流程

### 1. 状态保存（必须）

在压缩前，确保以下信息已持久化到文件：

```
□ 当前任务状态 → progress.md
□ 重要决策 → progress.md 决策记录表
□ 待确认假设 → progress.md 待确认列表
□ 未完成的代码变更 → 已保存到文件
```

### 2. 生成压缩摘要

创建 `memory-bank/_compact_summary.md`（临时文件）：

```markdown
# 上下文压缩摘要

## 会话概述

- 开始时间: [时间]
- 主要目标: [目标]
- 完成状态: [X/Y 任务完成]

## 关键决策

1. [决策1]: [原因]
2. [决策2]: [原因]

## 当前状态

- 正在进行: [任务]
- 阻塞项: [如有]

## 重要发现

- [发现1]
- [发现2]

## 下一步

- [待办1]
- [待办2]
```

### 3. 压缩策略

| 保留           | 移除                 |
| -------------- | -------------------- |
| 当前任务上下文 | 已完成任务的详细讨论 |
| 关键决策和原因 | 冗余的代码展示       |
| 待办事项       | 探索性的失败尝试     |
| 错误和解决方案 | 重复的文件读取       |
| 架构约束       | 已解决的问题讨论     |

### 4. 执行压缩

1. 更新 `progress.md` 的 `last_checkpoint` 字段
2. 输出压缩摘要
3. 提示用户执行 `/clear`

## 与 /clear 的区别

| 命令       | 行为                   | 适用场景                     |
| ---------- | ---------------------- | ---------------------------- |
| `/clear`   | 完全清除上下文         | 任务完成，开始新任务         |
| `/compact` | 智能压缩，保留关键信息 | 继续当前任务，但需要释放空间 |

## 输出格式

```
## 上下文压缩完成

### 已保存
- ✓ 进度状态 → progress.md
- ✓ 决策记录 → progress.md
- ✓ 压缩摘要 → _compact_summary.md

### 压缩摘要
[摘要内容]

### 下一步
执行 `/clear` 清除对话，然后执行 `/catchup` 恢复上下文。
```

## 注意事项

- 压缩前确保所有重要信息已保存
- `_compact_summary.md` 是临时文件，恢复后可删除
- 如果正在进行关键操作，先完成再压缩
