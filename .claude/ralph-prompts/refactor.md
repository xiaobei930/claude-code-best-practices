# Ralph Loop 提示词模板 - 代码重构

## 任务目标

按照重构计划逐步重构代码，确保每一步测试都通过。

整合项目的 `/cc-best:dev` 和 `/cc-best:qa` 角色，遵循安全重构原则。

## 重构计划

```
重构目标:
1. [重构目标1]
2. [重构目标2]
3. [重构目标3]
```

---

## 执行流程

### Phase 1: 分析（/cc-best:lead 角色思维）

1. **理解现状**
   - 读取相关代码
   - 理解模块依赖关系
   - 识别需要重构的部分

2. **制定计划**
   - 拆分为最小重构单元
   - 确定执行顺序
   - 识别风险点

### Phase 2: 重构循环（/cc-best:dev 角色）

每个重构目标执行：

```
1. 确保测试通过（GREEN 基线）
    ↓
2. 执行单个重构
   - 一次只改一个文件
   - 保持行为不变
    ↓
3. 运行测试
   - 通过 → 提交 → 下一个
   - 失败 → 回退 → 分析
```

### Phase 3: 验证（/cc-best:qa 角色）

1. **回归测试**
   - `/cc-best:test` - 运行所有测试
   - `/cc-best:build` - 构建验证

2. **代码审查**
   - 委派 `code-reviewer` agent 检查
   - 确认符合架构规范

### Phase 4: 提交

使用 `/cc-best:commit` 命令：

```
refactor(scope): 简短描述

重构内容: [说明]
影响范围: [涉及模块]
```

---

## 完成标准

当满足以下条件时输出 `<promise>REFACTOR_DONE</promise>`：

- [ ] 所有重构目标完成
- [ ] 所有测试通过（/test）
- [ ] 构建成功（/build）
- [ ] 代码风格一致
- [ ] 无遗留 TODO 或 FIXME
- [ ] 代码已提交（/commit）

---

## 重构原则（来自 CLAUDE.md）

### 安全重构

- **每次只改一个文件** - 降低风险
- **改完立即测试** - 快速反馈
- **测试不通过则回退** - 保护基线

### 简洁执念 (CP4)

- 函数单一职责
- 嵌套 ≤ 3 层
- 复杂度 ≤ 10

### 常见重构模式

| 模式        | 适用场景        |
| ----------- | --------------- |
| 提取函数    | 函数过长        |
| 提取类/模块 | 职责过多        |
| 重命名      | 命名不清晰      |
| 移动代码    | 位置不合理      |
| 简化条件    | 嵌套过深        |
| 消除重复    | 重复代码 ≥ 3 次 |

---

## 卡住时的处理

如果某个重构导致测试失败且难以修复：

1. **回退本次修改**
2. **记录失败原因**
3. **尝试更小粒度的重构**
4. 如果仍然失败，输出 `<promise>BLOCKED_REFACTOR</promise>`

---

## 输出格式

```markdown
## 重构迭代 #N

### 当前阶段

[分析 | 重构 | 验证 | 提交]

### 角色

[/cc-best:lead | /cc-best:dev | /cc-best:qa]

### 重构目标

[本次重构的具体目标]

### 执行动作

1. [动作1]
2. [动作2]

### 修改文件

- [文件1]: [修改说明]
- [文件2]: [修改说明]

### 测试结果

- 测试状态: 通过/失败
- 构建状态: 通过/失败
- 影响范围: [受影响的测试]

### 剩余目标

- [ ] 目标1
- [x] 目标2 (已完成)

### 下一步

[继续重构/完成信号]
```

---

## 使用示例

```bash
/ralph-loop "读取 .claude/ralph-prompts/refactor.md 作为执行指南。重构目标: 1. 提取 UserService 中的验证逻辑 2. 简化 OrderController 的条件判断" --max-iterations 30 --completion-promise "REFACTOR_DONE"
```
