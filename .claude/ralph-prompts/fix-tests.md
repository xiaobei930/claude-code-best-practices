# Ralph Loop 提示词模板 - 测试修复

## 任务目标

自动修复所有失败的测试，直到全部通过。

整合项目的 `/cc-best:dev` 和 `/cc-best:qa` 角色，区分代码 Bug 和测试本身问题。

---

## 执行流程

### Phase 1: 诊断（/cc-best:qa 角色）

1. **运行测试**
   - 执行 `/cc-best:test` 命令
   - 记录失败的测试

2. **分类失败原因**

   | 失败类型      | 定义         | 处理方式           |
   | ------------- | ------------ | ------------------ |
   | 编译/语法错误 | 代码无法编译 | 修复代码语法       |
   | 类型错误      | 类型不匹配   | 修复类型定义       |
   | 断言失败      | 行为不符预期 | 分析代码或测试问题 |
   | 超时问题      | 执行时间过长 | 优化性能或增加超时 |
   | 测试本身问题  | 测试逻辑有误 | 修复测试代码       |

### Phase 2: 修复循环（/cc-best:dev 角色）

按优先级修复：

```
1. 编译/语法错误（阻塞其他测试）
    ↓
2. 类型错误（可能影响多个测试）
    ↓
3. 断言失败（逐个分析修复）
    ↓
4. 超时问题（最后处理）
```

**关键原则**：

- **修复代码 Bug，而不是修改测试让它通过**
- 如果测试本身有问题，需要说明原因
- 每次只修复一个测试文件

### Phase 3: 验证（/cc-best:qa 角色）

1. **重新运行测试**
   - `/cc-best:test` - 验证修复效果
   - 确认无新增失败

2. **回归检查**
   - `/cc-best:build` - 构建验证
   - 确认整体状态

### Phase 4: 提交

使用 `/cc-best:commit` 命令：

```
fix(test): 修复 [模块] 测试失败

原因: [失败原因]
修复: [修复说明]
```

---

## 完成标准

当满足以下条件时输出 `<promise>ALL_GREEN</promise>`：

- [ ] 所有测试通过（/test）
- [ ] 无跳过的测试（除非有明确原因）
- [ ] 构建成功（/build）
- [ ] 修复已提交（/commit）

---

## 修复原则（来自 CLAUDE.md）

- **A5 问题分类** - 区分"代码 Bug"和"测试本身问题"
- **测试优先** - 测试是需求的验证，不能随意修改

### 何时修改测试

| 场景                 | 处理方式             |
| -------------------- | -------------------- |
| 代码行为错误         | 修复代码，保留测试   |
| 测试断言错误         | 修复测试，说明原因   |
| 需求变更导致测试过时 | 更新测试，记录变更   |
| Flaky 测试           | 修复测试，增加稳定性 |

---

## 卡住时的处理

如果同一个测试连续 3 次修复失败：

1. **记录测试名称和失败原因**
2. **标记为需要人工审查**
3. **跳过该测试继续其他修复**
4. 如果所有可修复的都完成，输出 `<promise>PARTIAL_GREEN</promise>`

---

## 输出格式

```markdown
## 测试修复迭代 #N

### 当前阶段

[诊断 | 修复 | 验证 | 提交]

### 角色

[/cc-best:qa | /cc-best:dev]

### 测试状态

- 总数: X
- 通过: Y
- 失败: Z
- 跳过: W

### 本次修复

- 文件: [文件路径]
- 失败类型: [编译/类型/断言/超时/测试问题]
- 问题: [问题描述]
- 修复: [修复方案]

### 验证结果

- 测试状态: 通过/失败
- 新增失败: 无/[列表]

### 剩余失败

- [ ] test_xxx - [原因]
- [ ] test_yyy - [原因]

### 下一步

[继续修复/完成信号]
```

---

## 使用示例

```bash
/ralph-loop "读取 .claude/ralph-prompts/fix-tests.md 作为执行指南，修复所有失败的测试" --max-iterations 30 --completion-promise "ALL_GREEN"
```
