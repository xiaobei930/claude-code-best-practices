# Ralph Loop 提示词模板 - Bug 修复

## 任务目标

分析并修复指定的 Bug，确保问题彻底解决且不引入新问题。

整合项目的 `/cc-best:dev` 和 `/cc-best:qa` 角色，遵循 TDD 修复流程。

## 输入

```
Bug 描述: {{BUG_DESCRIPTION}}
复现步骤: {{REPRODUCE_STEPS}}
预期行为: {{EXPECTED_BEHAVIOR}}
实际行为: {{ACTUAL_BEHAVIOR}}
```

---

## 修复流程（TDD 风格）

### Phase 1: 复现与分析（/cc-best:qa 角色）

1. **验证 Bug 存在**
   - 按照复现步骤操作
   - 确认问题确实存在
   - 记录错误信息/日志

2. **分类问题类型**（参考 /cc-best:qa 问题分类框架）

   | 类型             | 定义                 | 处理方式   |
   | ---------------- | -------------------- | ---------- |
   | **实现 Bug**     | 代码未按设计实现     | 直接修复   |
   | **边界遗漏**     | 未处理的边界情况     | 补充实现   |
   | **需求假设错误** | PM/Lead 假设不符实际 | 记录待确认 |

3. **如果无法复现**
   - 检查环境差异
   - 检查数据依赖
   - 输出 `<promise>CANNOT_REPRODUCE</promise>`

### Phase 2: 编写测试（/cc-best:dev + TDD）

1. **创建失败测试**（RED）
   - 编写能复现 Bug 的测试用例
   - 确认测试失败

2. **测试边界情况**
   - 识别相关边界条件
   - 添加边界测试用例

### Phase 3: 修复问题（/cc-best:dev 角色）

1. **最小修改原则**（GREEN）
   - 只修改必要的代码
   - 不做无关的重构

2. **验证修复**
   - 运行新增的测试（绿灯）
   - 运行完整测试套件
   - 前端 Bug 使用浏览器验证

### Phase 4: 验证（/cc-best:qa 角色）

1. **回归测试**
   - 运行 `/cc-best:test` 确保所有测试通过
   - 运行 `/cc-best:build` 确保构建成功

2. **问题闭环验证**
   - 按原复现步骤验证已修复
   - 确认无新问题引入

### Phase 5: 提交

使用 `/cc-best:commit` 命令，格式：

```
fix(scope): 简短描述

问题原因: [根因分析]
修复方案: [修复说明]

Closes #issue-number (如有)
```

---

## 完成标准

当满足以下**所有**条件时输出 `<promise>BUG_FIXED</promise>`：

- [ ] Bug 已复现并确认
- [ ] 根因已定位并分类
- [ ] 测试用例已添加（TDD RED）
- [ ] 修复代码已实现（TDD GREEN）
- [ ] 所有测试通过（/test）
- [ ] 构建成功（/build）
- [ ] 代码已提交（/commit）

---

## 关键规则（来自 CLAUDE.md）

- **P1 接口处理** - 调用前必须查阅文档，禁止猜测
- **A5 问题分类** - 区分"实现 Bug"和"需求假设错误"
- **测试先行** - 先写失败测试，再修复

---

## 卡住时的处理

### 无法定位原因

1. 添加更多日志
2. 缩小问题范围（二分法）
3. 如果仍然无法定位，输出 `<promise>BLOCKED_ANALYSIS</promise>`

### 修复引入新问题

1. 回退修改
2. 分析新问题原因
3. 尝试更安全的修复方案

---

## 输出格式

```markdown
## Bug 修复迭代 #N

### 当前阶段

[复现分析 | 编写测试 | 修复实现 | 验证 | 提交]

### 角色

[/cc-best:qa | /cc-best:dev]

### 执行动作

1. [动作1]
2. [动作2]

### 发现

- 问题类型: [实现 Bug | 边界遗漏 | 需求假设错误]
- 根因: [问题根因]
- 影响范围: [影响范围]

### 修改文件

- [文件1]: [修改说明]

### 测试结果

- 新增测试: X 个
- 测试状态: 通过/失败
- 构建状态: 通过/失败

### 下一步

[继续修复/完成信号]
```

---

## 使用示例

```bash
/ralph-loop "读取 .claude/ralph-prompts/bug-fix.md 作为执行指南。Bug: 用户登录后偶尔会被踢出，复现步骤是快速连续点击登录按钮" --max-iterations 20 --completion-promise "BUG_FIXED"
```
